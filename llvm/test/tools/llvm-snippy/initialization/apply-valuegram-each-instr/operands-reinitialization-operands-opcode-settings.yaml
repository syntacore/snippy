# RUN: llvm-snippy %s -model-plugin=None |& FileCheck %s

include:
  - ../../Inputs/sections.yaml

options:
    mtriple: riscv64-unknown-elf
    mattr: +f,+d
    dump-mf: on
    num-instrs: 100

histogram:
    - [FADD_S, 1.0]
    - [FADD_D, 1.0]

operands-reinitialization:
    - type: valuegram
      weight: 1.0
      opcodes:
        - "FADD_S":
            - type: operands
              values: [0x234, 0x431]
        - "FADD_D":
            - type: operands
              values: [0x235, uniform]

#          An example of what we're matching:
#               _
#              |    $x7 = ADDI $x0, 564, pcsections <0x5584a41a9008>
#              |    $f0_f = FMV_W_X $x7, pcsections <0x5584a41a9008>
#      Reinit <     $x25 = ADDI $x0, 1073, pcsections <0x5584a41a9008>
#              |_   $f17_f = FMV_W_X $x25, pcsections <0x5584a41a9008>
#                   $f29_f = FADD_S $f0_f, $f17_f, 1
#               _
#              |    $x7 = ADDI $x0, 565, pcsections <0x5584a41a9008>
#              |    $f19_d = FMV_D_X $x7, pcsections <0x5584a41a9008>
#      Reinit <     $x19 = <2nd operand uniform value initialization>
#              |_   $f27_d = FMV_D_X $x19, pcsections <0x5584a41a9008>
#                   $f24_d = FADD_D $f19_d, $f27_d, 3

# CHECK: [[XREG1:\$x[0-9]+]] = ADDI{{.*}}, 564{{.*[[:space:]].*}}[[FREG1:\$f[0-9]+_f]] = FMV_W_X [[XREG1]]{{.*[[:space:]].*}}[[XREG2:\$x[0-9]+]] = ADDI{{.*}}, 1073,{{.*[[:space:]].*}}[[FREG2:\$f[0-9]+_f]] = FMV_W_X [[XREG2]]{{.*[[:space:]].*}}[[FREG3:\$f[0-9]+_f]] = FADD_S [[FREG1]], [[FREG2]]{{.*}}

# CHECK-DAG: [[XREG3:\$x[0-9]+]] = ADDI{{.*}}, 565{{.*}}
# CHECK-DAG: [[FREG4:\$f[0-9]+_d]] = FMV_D_X [[XREG3]]{{.*}}
# CHECK-DAG: [[FREG5:\$f[0-9]+_d]] = FMV_D_X [[XREG4:\$x[0-9]+]]{{.*}}
# CHECK-DAG: [[FREG6:\$f[0-9]+_d]] = FADD_D [[FREG4]], [[FREG5]]{{.*}}

# CHECK-NOT: remark: No regex that matches "FADD_D" was found in opcode valuegram: This instruction will not be reinitializated
